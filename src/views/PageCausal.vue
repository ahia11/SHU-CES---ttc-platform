<template>
  <div class="page-container-story">
    <header class="page-header">
      <h1>ğŸ” ä¾¦æ¢ä¹‹æ—…ï¼šæŒ–æ˜T-T-Cçš„å› æœé“¾</h1>
      <p>
        â€œäº¤é€šâ€ã€â€œæ—…æ¸¸â€ã€â€œæ¶ˆè´¹â€ä¸‰è€…éƒ½åœ¨é«˜é€Ÿå¢é•¿ï¼Œä½†å®ƒä»¬ä¹‹é—´åˆ°åº•è°æ˜¯å› ï¼Œè°æ˜¯æœï¼Ÿ
      </p>
      <p class="narrative-intro">
        æœ¬é¡µå°†å¸¦æ‚¨ä½“éªŒä¸€æ¬¡æ•°æ®ä¾¦æ¢ä¹‹æ—…ï¼Œå±•ç¤ºæˆ‘ä»¬æ˜¯å¦‚ä½•ä»è¡¨é¢ç°è±¡ä¸€æ­¥æ­¥æ·±å…¥ï¼Œ
        <br />
        è¿ç”¨åˆ†ææ¨¡å‹æ¥æ¢ç´¢å®ƒä»¬ä¸‰è€…ä¹‹é—´åŠ¨æ€æ¼”åŒ–å…³ç³»çš„ã€‚
      </p>
    </header>

    <section class="narrative-step">
      <h2>æ­¥éª¤ä¸€ï¼šå®è§‚å…±æŒ¯ (The Hunch)</h2>
      <p class="narrative-text">
        æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šè¿™ä¸‰ä¸ªå˜é‡æ˜¯å¦â€œåŒé¢‘â€ï¼Ÿæˆ‘ä»¬ä» `yeardatas_converted.json` ä¸­æå–äº†ä¸‰é¡¹æ ¸å¿ƒæŒ‡æ ‡çš„çœŸå®æ•°æ®ï¼ˆ2005-2023ï¼‰ï¼Œå¹¶å°†å®ƒä»¬æ ‡å‡†åŒ–(Min-Max)åç»˜åˆ¶åœ¨åŒä¸€å¼ å›¾ä¸Šï¼Œæ¥è§‚å¯Ÿå®ƒä»¬çš„å®è§‚è¶‹åŠ¿ã€‚
      </p>
      <div class="chart-container-wrapper">
        <div v-if="!dataLoaded" class="loading-prompt">æ­£åœ¨åŠ è½½çœŸå®æ•°æ®...</div>
        <div class="chart-container" v-if="dataLoaded">
          <div class="chart-title">çœŸå®æ•°æ®è¶‹åŠ¿å¯¹æ¯” (å·²æ ‡å‡†åŒ–)</div>
          <v-chart class="chart" :option="timeSeriesOption" autoresize />
        </div>
      </div>
      <p class="narrative-insight">
        **åˆæ­¥å‘ç°ï¼š**
        ä¸‰æ¡æ›²çº¿çš„æ³¢åŠ¨é«˜åº¦ä¸€è‡´ï¼å®ƒä»¬æ˜¾ç„¶â€œåŒæ¶¨åŒè·Œâ€ï¼Œè¿™å¼ºåŠ›æš—ç¤ºäº†å®ƒä»¬ä¹‹é—´å­˜åœ¨ç´§å¯†çš„è”ç³»ã€‚
      </p>
    </section>

    <section class="narrative-step">
      <h2>æ­¥éª¤äºŒï¼šé‡åŒ–ç›¸å…³æ€§ (Gathering Clues)</h2>
      <p class="narrative-text">
        è‚‰çœ¼è§‚å¯Ÿè¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®¢è§‚çš„æ•°å­¦è¯æ®ã€‚æˆ‘ä»¬è®¡ç®—äº†è¿™ä¸‰ç»„æ•°æ®ï¼ˆæ ‡å‡†åŒ–åï¼‰çš„**çš®å°”é€Šç›¸å…³ç³»æ•° (Pearson Correlation)**ï¼Œå®ƒè¡¡é‡å˜é‡é—´çº¿æ€§å…³ç³»çš„å¼ºåº¦ï¼ˆ-1åˆ°1ï¼‰ã€‚
      </p>
      <div class="chart-container-wrapper">
        <div class="chart-container" style="height: 450px">
          <div class="chart-title">ç›¸å…³æ€§çƒ­åŠ›å›¾ (åŸºäº2005-2023æ•°æ®)</div>
          <v-chart class="chart" :option="correlationOption" autoresize />
        </div>
      </div>
      <p class="narrative-insight">
        **å…³é”®çº¿ç´¢ï¼š**
        çƒ­åŠ›å›¾æ˜¾ç¤ºï¼Œæ‰€æœ‰å˜é‡é—´çš„ç›¸å…³æ€§å‡ > 0.95ï¼Œå‘ˆ**æå¼ºæ­£ç›¸å…³**ã€‚
        <br />
        ä½†è¿™å¸¦æ¥äº†ä¸€ä¸ªæ›´æ£˜æ‰‹çš„é—®é¢˜ï¼šæ˜¯äº¤é€š(T)æ‹‰åŠ¨äº†æ¶ˆè´¹(C)ï¼Ÿè¿˜æ˜¯æ¶ˆè´¹(C)åå“ºäº†äº¤é€š(T)ï¼Ÿè¿˜æ˜¯ä¸¤è€…äº’ç›¸æ‹‰åŠ¨ï¼Ÿ
      </p>
    </section>

    <section class="narrative-step">
      <h2>æ­¥éª¤ä¸‰ï¼šæ—¶åºä¸å› æœ (The "Chicken & Egg" Problem)</h2>
      <p class="narrative-text">
        ä¸ºäº†è§£å¼€â€œé¸¡ç”Ÿè›‹è¿˜æ˜¯è›‹ç”Ÿé¸¡â€çš„è°œé¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº†ç»æµå­¦ä¸­çš„æ—¶åºåˆ†ææ¨¡å‹ï¼ˆå¦‚æ ¼å…°æ°å› æœæ£€éªŒæˆ–å‘é‡è‡ªå›å½’(VAR)æ¨¡å‹ï¼‰ã€‚è¿™äº›æ¨¡å‹çš„æ ¸å¿ƒæ˜¯æ£€éªŒä¸€ä¸ªå˜é‡çš„**å†å²å€¼**æ˜¯å¦èƒ½æ˜¾è‘—â€œé¢„æµ‹â€å¦ä¸€ä¸ªå˜é‡çš„**æœªæ¥å€¼**ã€‚
        <br />
        æˆ‘ä»¬åˆ†åˆ«å¯¹**æ—©æœŸ (2005-2014)** å’Œ**åæœŸ (2015-2023)** ä¸¤ä¸ªé˜¶æ®µè¿›è¡Œäº†å»ºæ¨¡ï¼Œå¾—åˆ°äº†æƒŠäººçš„å‘ç°ï¼š
      </p>

      <div class="stage-switcher">
        <button
          :class="{ active: currentPeriod === 'early' }"
          @click="currentPeriod = 'early'"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" />
          </svg>
          åˆ†æé˜¶æ®µä¸€ï¼šæ—©æœŸ (2005-2014)
        </button>
        <button
          :class="{ active: currentPeriod === 'late' }"
          @click="currentPeriod = 'late'"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.204-4.608L3.43 4.13a.75.75 0 00-1.06 1.06l2.122 2.122a5.5 5.5 0 019.062 4.904l2.688 2.688a.75.75 0 101.06-1.06l-2.002-2.002zM10 5.5a4 4 0 100 8 4 4 0 000-8z" clip-rule="evenodd" />
          </svg>
          åˆ†æé˜¶æ®µäºŒï¼šåæœŸ (2015-2023)
        </button>
      </div>

      <div class="charts-grid-2">
        <div class="chart-container">
          <div class="chart-title">
            æ¨¡å‹ç»“æœ 1ï¼šåŠ¨æ€å› æœç½‘ç»œ ({{ currentPeriodText }})
          </div>
          <v-chart class="chart" :option="graphOption" autoresize />
        </div>
        <div class="chart-container">
          <div class="chart-title">
            æ¨¡å‹ç»“æœ 2ï¼šè„‰å†²å“åº” ({{ currentPeriodText }})
          </div>
          <p class="chart-subtitle">
            (æ¨¡æ‹Ÿå½“æœŸâ€œäº¤é€šâ€å—åˆ°å†²å‡»åï¼Œå¯¹â€œæ¶ˆè´¹â€çš„æœªæ¥å½±å“)
          </p>
          
          <div class="model-control-slider">
            <label for="shock-slider">å†²å‡»å¼ºåº¦: {{ shockAmount.toFixed(1) }}x</label>
            <input 
              id="shock-slider"
              type="range" 
              v-model.number="shockAmount" 
              min="0.5" 
              max="3.0" 
              step="0.1"
            />
          </div>

          <v-chart class="chart" :option="irfOption" ref="irfChartRef" autoresize />
        </div>
      </div>

      <div class="narrative-insight">
        **æ¨¡å‹è§£è¯» (è¯·åˆ‡æ¢é˜¶æ®µæŸ¥çœ‹)ï¼š**
        <br />
        <ul>
          <li>
            **æ—©æœŸé˜¶æ®µï¼š**
            æˆ‘ä»¬è§‚å¯Ÿåˆ°ä¸€æ¡æ¸…æ™°çš„**å•å‘é©±åŠ¨é“¾**ã€‚äº¤é€š(T)æ˜¯ç»å¯¹çš„æ ¸å¿ƒï¼Œå®ƒå¼ºåŠ›é©±åŠ¨ç€æ¶ˆè´¹(C)å’Œæ—…æ¸¸(T2)ã€‚è„‰å†²å“åº”å›¾ä¹Ÿæ˜¾ç¤ºï¼Œäº¤é€šçš„å†²å‡»èƒ½å¯¹æ¶ˆè´¹äº§ç”Ÿå¼ºå¤§ä¸”æŒä¹…ï¼ˆæ»å4æœŸè¾¾åˆ°å³°å€¼ï¼‰çš„æ‹‰åŠ¨ä½œç”¨ã€‚
          </li>
          <li>
            **åæœŸé˜¶æ®µï¼š**
            å…³ç³»å‘ç”Ÿäº†è´¨å˜ï¼å®ƒè¿›åŒ–æˆäº†ä¸€ä¸ª**åŒå‘äº’å“ºçš„å¤æ‚ç½‘ç»œ**ã€‚äº¤é€š(T)å’Œæ¶ˆè´¹(C)å¼€å§‹äº’ç›¸æ‹‰åŠ¨ï¼Œæ—…æ¸¸(T2)å’Œæ¶ˆè´¹(C)ä¹Ÿå½¢æˆäº†åŒå‘å¾ªç¯ã€‚è„‰å†²å“åº”æ˜¾ç¤ºï¼Œäº¤é€šå¯¹æ¶ˆè´¹çš„å†²å‡»å“åº”æ›´å¿«ï¼ˆæ»å2æœŸè¾¾å³°ï¼‰ï¼Œä½†å³°å€¼é™ä½ï¼Œè¯´æ˜æ¶ˆè´¹çš„å¢é•¿å·²ä¸å®Œå…¨ä¾èµ–äº¤é€šï¼Œæœ‰äº†è‡ªå·±çš„å†…ç”ŸåŠ¨åŠ›ã€‚
          </li>
        </ul>
      </div>
    </section>

    <section class="narrative-step final-verdict">
      <h2>æ­¥éª¤å››ï¼šæœ€ç»ˆç»“è®º (The Verdict)</h2>
      
      <p class="narrative-text">
        æˆ‘ä»¬çš„æ•°æ®ä¾¦æ¢ä¹‹æ—…èµ°åˆ°äº†ç»ˆç‚¹ã€‚é€šè¿‡ä»â€œå®è§‚å…±æŒ¯â€åˆ°â€œç›¸å…³åˆ†æâ€å†åˆ°â€œå› æœå»ºæ¨¡â€çš„å±‚å±‚æ·±å…¥ï¼Œæˆ‘ä»¬æ­ç¤ºäº†T-T-Cå…³ç³»çš„çœŸç›¸ï¼š
      </p> 
      
      <ol class="verdict-list">
        <li>
          **å®ƒä»¬ä¸æ˜¯ç®€å•çš„ç›¸å…³ï¼Œè€Œæ˜¯å­˜åœ¨æ—¶åºå› æœå…³ç³»ã€‚**
        </li>
        <li>
          **è¿™ç§å› æœå…³ç³»ä¸æ˜¯é™æ€çš„ï¼Œè€Œæ˜¯åŠ¨æ€æ¼”åŒ–çš„ã€‚**
        </li>
        <li>
          **æ—©æœŸ (2005-2014)ï¼š** æ˜¯â€œäº¤é€šå»ºè®¾â€é©±åŠ¨â€œç»æµæˆæœâ€çš„**å•å‘æ‹‰åŠ¨**æ¨¡å¼ã€‚
        </li>
        <li>
          **åæœŸ (2015-2023)ï¼š**
          è¿›åŒ–ä¸ºâ€œåŸºå»ºã€æ—…æ¸¸ã€æ¶ˆè´¹â€ä¸‰è€…**åŒå‘äº’å“ºã€å†…ç”Ÿå¾ªç¯**çš„å¥åº·ç”Ÿæ€ã€‚
        </li>
      </ol>
      <p class="narrative-end">
        è¿™ä¸ªç»“è®ºå±•ç°äº†ä¸­å›½ç»æµç»“æ„ä»â€œæŠ•èµ„æ‹‰åŠ¨â€å‘â€œå†…éœ€é©±åŠ¨â€çš„å®è§‚è½¬å˜ã€‚
      </p>
    </section>
  </div>
</template>

<script setup>
import { ref, onMounted, computed, watch } from 'vue'

// --- ECharts æŒ‰éœ€å¼•å…¥ (ä¸å˜) ---
import { use } from 'echarts/core'
import { CanvasRenderer } from 'echarts/renderers'
import { LineChart, HeatmapChart, GraphChart, EffectScatterChart } from 'echarts/charts'
import { TooltipComponent, LegendComponent, GridComponent, VisualMapComponent, MarkPointComponent, TitleComponent, GraphicComponent } from 'echarts/components'
import { graphic } from 'echarts/core' // ä¿æŒ

// ã€âœ… ä¿®å¤ã€‘å¯¼å…¥ VChart ç»„ä»¶ (ä¸å˜)
import VChart from 'vue-echarts'

use([ CanvasRenderer, LineChart, HeatmapChart, GraphChart, TooltipComponent, LegendComponent, GridComponent, VisualMapComponent, MarkPointComponent, TitleComponent, GraphicComponent, ])
// --- æŒ‰éœ€å¼•å…¥ç»“æŸ ---

const dataLoaded = ref(false)
const currentPeriod = ref('early')
const currentPeriodText = computed(() =>
  currentPeriod.value === 'early' ? 'æ—©æœŸ' : 'åæœŸ'
)

// å›¾è¡¨ refs
const timeSeriesOption = ref({})
const correlationOption = ref({})
const graphOption = ref({})
const irfOption = ref({}) // <v-chart> å·²ç»ç»‘å®šåˆ°è¿™ä¸ª ref

// ã€HCI æ”¹è¿›ã€‘æ–°å¢å›¾è¡¨ Ref å’Œæ»‘å— Ref
const irfChartRef = ref(null) // è¿™ä¸ª ref ä»ç„¶æœ‰ç”¨ï¼Œä¾‹å¦‚ç”¨äº dispatchAction
const shockAmount = ref(1.0)


// --- æ¨¡æ‹Ÿæ•°æ® (ä¸å˜) ---
let iconPaths = {}
let graphNodes = []
let links_early = []
let links_late = []
// ã€HCI æ”¹è¿›ã€‘å®šä¹‰åŸºç¡€æ•°æ®
const irfData_early_base = [0.1, 0.3, 0.55, 0.7, 0.65, 0.5, 0.3, 0.1, 0.05, 0]
const irfData_late_base = [0.2, 0.45, 0.3, 0.2, 0.15, 0.1, 0.05, 0, 0, 0]

onMounted(() => {
  defineSimulatedData()
  loadRealData()
  setCorrelationChart()
  updateModels('early', shockAmount.value) // é¦–æ¬¡åŠ è½½
})

// ã€HCI æ”¹è¿›ã€‘ç›‘å¬æ»‘å—å’Œæ—¶æœŸçš„å˜åŒ– (ä¸å˜)
watch(shockAmount, (newAmount) => {
  updateModels(currentPeriod.value, newAmount)
})
watch(currentPeriod, (newPeriod) => {
  updateModels(newPeriod, shockAmount.value)
})


// æ­¥éª¤ä¸€ï¼šåŠ è½½çœŸå®æ•°æ® (ä¸å˜)
const loadRealData = async () => {
  try {
    // ã€ä»£ç ä¿®å¤ã€‘è·¯å¾„å·²æ”¹å›æŒ‡å‘ /public/ ç›®å½•
    const response = await fetch('/data/yeardatas_converted.json')
    if (!response.ok) throw new Error('yeardatas_converted.json åŠ è½½å¤±è´¥')
    
    const nationalData = await response.json()
    const years = Array.from({ length: 2023 - 2005 + 1 }, (_, i) => (2005 + i).toString())
    
    const extractAndNormalize = (key) => {
      const dataSeries = nationalData[key]
      if (!dataSeries) { console.warn(`æ•°æ®ä¸­æœªæ‰¾åˆ° key: ${key}`); return new Array(years.length).fill(null) }
      const filteredData = dataSeries.filter(d => parseInt(d['å¹´ä»½'], 10) <= 2023)
      const dataMap = new Map(filteredData.map((d) => [d['å¹´ä»½'], d['æ•°å€¼']]))
      const rawData = years.map((year) => dataMap.get(year) || null)
      const validData = rawData.filter(v => v !== null && v !== undefined).map(v => parseFloat(v)) // ç¡®ä¿æ˜¯æ•°å­—
      if (validData.length === 0) return rawData;
      const min = Math.min(...validData)
      const max = Math.max(...validData)
      if (min === max) return rawData.map(v => (v === null || v === undefined) ? null : 0)
      return rawData.map(v => (v === null || v === undefined) ? null : (v - min) / (max - min))
    }
    
    const transportData = extractAndNormalize('é“è·¯è¥ä¸šé‡Œç¨‹(ä¸‡å…¬é‡Œ)')
    const tourismData = extractAndNormalize('å›½å†…æ¸¸å®¢(ç™¾ä¸‡äººæ¬¡)')
    const consumptionData = extractAndNormalize('å±…æ°‘æ¶ˆè´¹æ°´å¹³(å…ƒ)')
    
    setTimeSeriesChart(years, transportData, tourismData, consumptionData)
    dataLoaded.value = true
  } catch (error) {
    console.error('çœŸå®æ•°æ®åŠ è½½å¤±è´¥:', error)
    dataLoaded.value = true;
    timeSeriesOption.value = {
      title: {
        text: 'çœŸå®æ•°æ®åŠ è½½å¤±è´¥', left: 'center', top: 'center',
        textStyle: { color: '#f87171' }
      }
    }
  }
}

// å›¾è¡¨ 1: å®è§‚å…±æŒ¯å›¾ (ä¸å˜)
function setTimeSeriesChart(years, transport, tourism, consumption) {
  timeSeriesOption.value = {
    backgroundColor: 'transparent',
    tooltip: { trigger: 'axis' },
    legend: {
      data: ['äº¤é€š (é“è·¯)', 'æ—…æ¸¸ (æ¸¸å®¢)', 'æ¶ˆè´¹ (æ°´å¹³)'],
      top: 10,
      // ã€BUG ä¿®å¤ã€‘(ä¸å˜)
      textStyle: { color: '#333333' }, // é€‰ä¸­æ—¶é¢œè‰²
      inactiveColor: '#999999'       // æœªé€‰ä¸­æ—¶é¢œè‰²
    },
    grid: { left: '10%', right: '5%', bottom: '15%' },
    xAxis: {
      type: 'category',
      boundaryGap: false,
      data: years,
      axisLine: { lineStyle: { color: 'var(--border-color)' } }, 
    },
    yAxis: {
      type: 'value',
      name: 'æ ‡å‡†åŒ–å€¼ (Min-Max)',
      nameTextStyle: { color: 'var(--text-color-light)' }, 
      axisLine: { lineStyle: { color: 'var(--border-color)' } }, 
      splitLine: { lineStyle: { color: 'var(--border-color)', type: 'dashed' } }, 
    },
    series: [
      { name: 'äº¤é€š (é“è·¯)', type: 'line', smooth: true, data: transport, lineStyle: { color: '#f87171' }, },
      { name: 'æ—…æ¸¸ (æ¸¸å®¢)', type: 'line', smooth: true, data: tourism, lineStyle: { color: '#38bdf8' }, },
      { name: 'æ¶ˆè´¹ (æ°´å¹³)', type: 'line', smooth: true, data: consumption, lineStyle: { color: '#4ade80' }, },
    ],
  }
}

// å›¾è¡¨ 2: ç›¸å…³æ€§çƒ­åŠ›å›¾ (ä¸å˜)
function setCorrelationChart() {
  const data = [ [0, 0, 1], [0, 1, 0.96], [0, 2, 0.98], [1, 0, 0.96], [1, 1, 1], [1, 2, 0.95], [2, 0, 0.98], [2, 1, 0.95], [2, 2, 1], ];
  const labels = ['äº¤é€š', 'æ—…æ¸¸', 'æ¶ˆè´¹'];

  correlationOption.value = {
    backgroundColor: 'transparent',
    tooltip: {
      position: 'top',
      formatter: (p) => `${labels[p.data[0]]} ä¸ ${labels[p.data[1]]} çš„ç›¸å…³æ€§: ${p.data[2]}`,
    },
    grid: { left: '10%', right: '10%', bottom: '15%', top: '10%' },
    xAxis: {
      type: 'category',
      data: labels,
      splitArea: { show: true },
      axisLine: { lineStyle: { color: 'var(--border-color)' } }, 
    },
    yAxis: {
      type: 'category',
      data: labels,
      splitArea: { show: true },
      axisLine: { lineStyle: { color: 'var(--border-color)' } }, 
    },
    visualMap: {
      min: 0.9,
      max: 1,
      calculable: true,
      orient: 'horizontal',
      left: 'center',
      bottom: '0',
      textStyle: { color: 'var(--text-color)' }, 
      inRange: {
        color: ['rgba(0, 122, 255, 0.3)', 'rgba(248, 113, 113, 1)'], 
      },
    },
    series: [
      {
        type: 'heatmap',
        data: data,
        label: {
          show: true,
          formatter: (p) => p.data[2].toFixed(2),
          color: '#000', 
        },
        emphasis: {
          itemStyle: { borderColor: '#fff', borderWidth: 1 },
        },
      },
    ],
  }
}

// æ­¥éª¤ä¸‰ï¼šæ›´æ–°æ¨¡å‹å›¾è¡¨
const updateModels = (period, amount) => {
 
  // --- 1. æ›´æ–°å› æœå›¾ --- (ä¸å˜)
  graphOption.value = {
    backgroundColor: 'transparent',
    tooltip: {
        formatter: (params) => {
            if (params.dataType === 'edge') {
                const labelText = params.data?.label?.formatter; 
                return labelText ? `å…³ç³»: ${labelText}` : 'å…³ç³»: (æ— )';
            }
            return params.name;
        }
    },
    series: [
      {
        type: 'graph',
        layout: 'force',
        roam: true,
        animationDuration: 1500,
        data: graphNodes,
        links: period === 'early' ? links_early : links_late, 
        label: { show: true, position: 'right', color: 'var(--text-color)', fontSize: 14 }, 
        edgeSymbol: ['none', 'arrow'],
        edgeSymbolSize: [4, 12],
        edgeLabel: { 
            show: true, 
            fontSize: 12, 
            color: 'var(--text-color)', 
            textBorderColor: 'var(--sidebar-bg)', 
            textBorderWidth: 2,
            formatter: (params) => {
                return params.data?.label?.formatter || ''; 
            }
        },
        force: { repulsion: 400, edgeLength: 180, gravity: 0.1, layoutAnimation: true },
      },
    ],
  }

  // --- 2. æ›´æ–°è„‰å†²å“åº”å›¾ --- (ä¸å˜)
  const baseData = period === 'early' ? irfData_early_base : irfData_late_base;
  const currentIrfData = baseData.map(val => val * amount); 
  const peakTime = period === 'early' ? 'æ»å4æœŸ' : 'æ»å2æœŸ';
  const yMax = Math.max(0.8 * 3.0, 0.5 * 3.0); // ç¡®ä¿Yè½´æœ€å¤§å€¼å›ºå®šï¼Œé˜²æ­¢ç¼©æ”¾è·³åŠ¨

  const newIrfOption = {
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'axis',
      formatter: (params) => `æ»åæœŸ ${params[0].axisValue}: å†²å‡»å“åº” ${params[0].value.toFixed(2)}`
    },
    grid: { left: '12%', right: '8%', bottom: '15%', top: '25%' }, 
    xAxis: {
      type: 'category',
      boundaryGap: false,
      data: Array.from({ length: 10 }, (_, i) => `T+${i}`), 
      axisLine: { lineStyle: { color: 'var(--border-color)' } }, 
    },
    yAxis: {
      type: 'value',
      name: 'å“åº”ç¨‹åº¦',
      nameTextStyle: { color: 'var(--text-color-light)' }, 
      axisLine: { lineStyle: { color: 'var(--border-color)' } }, 
      splitLine: { lineStyle: { color: 'var(--border-color)', type: 'dashed' } }, 
      max: yMax, // å›ºå®š Y è½´æœ€å¤§å€¼
      min: 0,
    },
    series: [
      {
        name: 'å†²å‡»å“åº”',
        type: 'line',
        smooth: true,
        data: currentIrfData, 
        lineStyle: { color: '#38bdf8' }, 
        areaStyle: {
          color: new graphic.LinearGradient(0, 0, 0, 1, [
            { offset: 0, color: 'rgba(56, 189, 248, 0.5)' },
            { offset: 1, color: 'rgba(56, 189, 248, 0)' }
          ])
        },
        markPoint: {
          data: [
            { type: 'max', name: 'å³°å€¼', symbol: 'pin', itemStyle: { color: '#f87171' } }
          ],
          label: {
            formatter: (params) => `${params.name}: ${peakTime} (å€¼: ${params.value.toFixed(2)})`,
            color: '#fff', 
            backgroundColor: '#f87171',
            padding: [4, 8],
            borderRadius: 4
          }
        }
      }
    ]
  };

  // ==========================================
  // ã€âœ… BUG ä¿®å¤ã€‘
  // ä¸å†ä½¿ç”¨ if/else å’Œ irfChartRef.value.setOption()
  // è€Œæ˜¯ç›´æ¥æ›´æ–°å·²ç»‘å®šçš„ ref (irfOption.value)
  // vue-echarts ä¼šè‡ªåŠ¨ç›‘å¬åˆ°è¿™ä¸ªå˜åŒ–å¹¶æ›´æ–°å›¾è¡¨
  // ==========================================
  irfOption.value = newIrfOption;
}

/* --- (è¡¥å……) å› æœå›¾æ¨¡æ‹Ÿæ•°æ® (ä¸å˜) --- */
function defineSimulatedData() {
  graphNodes = [
    { name: 'äº¤é€š (T)', symbolSize: 80, itemStyle: { color: '#f87171' } },
    { name: 'æ—…æ¸¸ (T2)', symbolSize: 60, itemStyle: { color: '#38bdf8' } },
    { name: 'æ¶ˆè´¹ (C)', symbolSize: 60, itemStyle: { color: '#4ade80' } },
  ]
  links_early = [
    { source: 'äº¤é€š (T)', target: 'æ¶ˆè´¹ (C)', lineStyle: { width: 5, color: '#f87171' }, label: { show: true, formatter: 'å¼ºé©±åŠ¨' } },
    { source: 'äº¤é€š (T)', target: 'æ—…æ¸¸ (T2)', lineStyle: { width: 3, color: '#f87171' }, label: { show: true, formatter: 'é©±åŠ¨' } },
  ]
  links_late = [
    { source: 'äº¤é€š (T)', target: 'æ¶ˆè´¹ (C)', lineStyle: { width: 5, color: '#f87171', curveness: 0.2 }, label: { show: true, formatter: 'åŒå‘äº’å“º' }, effect: { show: true, symbol: 'arrow', symbolSize: 10, trailLength: 0.1, color: 'var(--text-color)' } }, 
    { source: 'æ¶ˆè´¹ (C)', target: 'äº¤é€š (T)', lineStyle: { width: 5, color: '#4ade80', curveness: 0.2 }, effect: { show: true, symbol: 'arrow', symbolSize: 10, trailLength: 0.1, color: 'var(--text-color)' } }, 
    { source: 'æ—…æ¸¸ (T2)', target: 'æ¶ˆè´¹ (C)', lineStyle: { width: 3, color: '#38bdf8', curveness: -0.2 }, label: { show: true, formatter: 'åŒå‘æ‹‰åŠ¨' }, effect: { show: true, symbol: 'arrow', symbolSize: 8, trailLength: 0.1, color: 'var(--text-color)' } }, 
    { source: 'æ¶ˆè´¹ (C)', target: 'æ—…æ¸¸ (T2)', lineStyle: { width: 3, color: '#4ade80', curveness: -0.2 }, effect: { show: true, symbol: 'arrow', symbolSize: 8, trailLength: 0.1, color: 'var(--text-color)' } }, 
  ]
}
</script>

<style scoped>
/* å®šä¹‰ Page 3 è‡ªå·±çš„ä¸»é¢˜è‰² (ç»¿è‰²) */
.page-container-story {
  --page-accent: #4ade80;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
  color: var(--text-color); 
}

/* å™äº‹å¤´éƒ¨ */
.page-header {
  text-align: center;
  margin-bottom: 3rem;
  border-bottom: 1px solid var(--border-color);
  padding-bottom: 2rem;
}
.page-header h1 {
  font-size: 2.8rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  background: linear-gradient(90deg, var(--page-accent) 0%, var(--text-color) 100%);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.page-header p {
  font-size: 1.2rem;
  color: var(--text-color-light);
  margin-bottom: 0;
}
.page-header p.narrative-intro {
  font-size: 1rem;
  color: var(--text-color-light);
  margin-top: 1rem;
}

/* å™äº‹æ­¥éª¤ */
.narrative-step {
  margin-bottom: 4rem;
}
.narrative-step h2 {
  font-size: 2rem;
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 1rem;
  border-bottom: 2px solid var(--page-accent); 
  padding-bottom: 0.5rem;
  display: inline-block;
}
.narrative-text {
  font-size: 1.1rem;
  color: var(--text-color-light);
  line-height: 1.8;
  margin-bottom: 1.5rem;
}
.narrative-insight {
  font-size: 1.1rem;
  color: var(--text-color);
  line-height: 1.8;
  margin-top: 1.5rem;
  background-color: var(--sidebar-bg); 
  border: 1px solid var(--border-color); 
  border-left: 4px solid var(--page-accent); 
  padding: 1rem 1.5rem;
  border-radius: 8px;
}
.narrative-insight ul, .narrative-insight ol {
  padding-left: 1.5rem;
  margin-top: 0.5rem;
}

/* å›¾è¡¨å®¹å™¨ */
.chart-container-wrapper {
  width: 100%;
  margin-bottom: 1rem;
}
.chart-container {
  position: relative;
  height: 500px;
  width: 100%;
  background-color: var(--sidebar-bg); 
  border-radius: 12px;
  padding: 1.5rem;
  border: 1px solid var(--border-color); 
  box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05); 
}
.chart-title {
  position: absolute;
  top: 1.5rem;
  left: 1.5rem;
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text-color); 
  z-index: 10;
}
.chart-subtitle {
  position: absolute;
  top: 3.5rem;
  left: 1.5rem;
  font-size: 0.9rem;
  font-weight: 400;
  color: var(--text-color-light); 
  z-index: 10;
}
.chart {
  height: 100%;
  width: 100%;
}
.loading-prompt {
  color: var(--text-color-light);
  font-size: 1.2rem;
  text-align: center;
  padding: 2rem;
  background-color: var(--sidebar-bg); 
  border-radius: 12px;
  border: 1px solid var(--border-color);
  height: 500px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ã€HCI æ”¹è¿›ã€‘æ»‘å—æ ·å¼ */
.model-control-slider {
  position: absolute;
  top: 5.5rem;
  left: 1.5rem;
  right: 1.5rem;
  z-index: 10;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(4px);
  padding: 0.25rem 0.5rem;
  border-radius: 6px;
}
.model-control-slider label {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-color-light);
}
.model-control-slider input[type="range"] {
  flex-grow: 1;
  accent-color: var(--page-accent);
}
/* è°ƒæ•´å›¾è¡¨å†…è¾¹è·ä¸ºæ»‘å—è…¾å‡ºç©ºé—´ */
.chart-container .chart {
  padding-top: 3.5rem; 
}


/* åµŒå…¥å¼ 2x2 ç½‘æ ¼ (ä¸å˜) */
.charts-grid-2 {
  display: grid;
  grid-template-columns: 1fr; 
  gap: 1.5rem;
  margin-top: 1.5rem;
}
@media (min-width: 1024px) {
  .charts-grid-2 {
    grid-template-columns: 1fr 1fr;
  }
  .charts-grid-2 .chart-container {
    height: 450px;
  }
}

/* é˜¶æ®µåˆ‡æ¢å™¨ */
.stage-switcher {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin-top: 1rem;
  padding: 0.75rem;
  border-radius: 12px;
  flex-wrap: wrap; /* ç§»åŠ¨ç«¯æ¢è¡Œ */
}
.stage-switcher button {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background-color: var(--sidebar-bg); 
  border: 2px solid var(--border-color); 
  color: var(--text-color-light); 
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 1rem;
  font-weight: 600;
}
.stage-switcher button:hover {
  background-color: var(--bg-color); 
  color: var(--text-color); 
}
.stage-switcher button.active {
  background-color: var(--page-accent); 
  border-color: var(--page-accent); 
  color: #000; /* ç»¿è‰²èƒŒæ™¯ç”¨é»‘è‰²å­—æ›´æ¸…æ™° */
  box-shadow: 0 0 15px rgba(74, 222, 128, 0.5);
}
.stage-switcher button svg {
  width: 1.25rem;
  height: 1.25rem;
}

/* æœ€ç»ˆç»“è®º */
.final-verdict {
  text-align: center;
  background-color: var(--sidebar-bg); 
  border-radius: 12px;
  padding: 2rem;
  border: 1px solid var(--page-accent); 
}
.final-verdict h2 {
  border: none;
  display: block;
}
.verdict-list {
  list-style-type: decimal;
  display: inline-block;
  text-align: left;
  font-size: 1.2rem;
  line-height: 2;
  color: var(--text-color);
  margin-top: 1.5rem;
  margin-bottom: 2rem;
}
.narrative-end {
  font-size: 1.1rem;
  color: var(--text-color-light);
  line-height: 1.8;
}
</style>